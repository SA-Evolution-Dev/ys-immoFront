<nav class="mb-3" aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="javascript:void(0)">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="javascript:void(0)">Nouvelle annonce</a></li>
    </ol>
</nav>

<h2 class="mb-3">Nouvelle annonce</h2>
<div class="row">
    <div class="col-xl-9">
        <form [formGroup]="bienForm" (ngSubmit)="onSubmitForm()" class="row g-2 mb-6">
            <!-- SECTION 1 : INFORMATIONS G√âN√âRALES -->
            <div class="col-12">
                <div class="section-header">
                    <label class="section-title">
                        <i class="fas fa-home text-primary me-2"></i>
                        Informations g√©n√©rales
                    </label>
                    <p class="text-muted small mb-1">
                        D√©crivez votre bien pour attirer les meilleurs clients
                    </p>
                </div>
            </div>

            <div class="col-sm-6 col-md-12">
                <div class="form-floating">
                    <input id="title" type="text" 
                        formControlName="title" placeholder="Donner un titre ici" 
                        class="form-control" [class.is-invalid]="isFieldInvalid('title')" />
                    <label for="title">Titre de l'annonce <span class="text-danger"> *</span></label>
                </div>
                @if (isFieldInvalid('title')) {
                    <span class="error-message">Veuillez saisir le titre de l'annonce</span>
                }
            </div>

            <!-- TYPE DE BIEN -->
            <div class="col-md-12">
                <div class="form-floating">
                    <select id="type" formControlName="type"
                        class="form-select" [class.is-invalid]="isFieldInvalid('type')">
                        <option value="">-- S√©lectionnez --</option>
                        <option value="appartement">üè¢ Appartement</option>
                        <option value="villa">üè† Villa</option>
                        <option value="studio">üõèÔ∏è Studio (T1)</option>
                        <!-- <option value="bureau">üè¨ Bureau / Local commercial</option> -->
                    </select>
                    <label for="type">Type de bien <span class="text-danger">*</span></label>
                </div>
                @if (isFieldInvalid('type')) {
                    <span class="error-message">Veuillez s√©lectionner le type de bien</span>
                }
            </div>

            <!-- Surface -->
            <div class="col-md-6">
                <div class="form-floating">
                    <input id="surface" type="number" 
                        formControlName="surface" placeholder="Ex: 120" 
                        class="form-control" [class.is-invalid]="isFieldInvalid('surface')" />
                    <label for="surface">
                        Surface m¬≤ (optionnel)
                    </label>
                </div>
                @if (isFieldInvalid('surface')) {
                    <span class="error-message">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        Veuillez indiquer la surface du bien
                    </span>
                }
            </div>

            <!-- STATUT -->
            <div class="col-sm-6 col-md-6">
                <div class="form-floating">
                    <select id="statut" formControlName="statut" class="form-select"
                        class="form-control" [class.is-invalid]="isFieldInvalid('statut')">
                        <option value="brouillon">üìù Brouillon (Ne pas publier) </option>
                        <option value="actif">‚úÖ Je veux (Publier mon annonce) </option>
                    </select>
                    <label for="statut">Statut</label>
                </div>
                @if (isFieldInvalid('statut')) {
                    <span class="error-message">Veuillez s√©lectionner le statut</span>
                }
            </div>

            <!-- COMPOSITION GROUP -->
            <div class="col-12">
                <label class="mt-1 mb-1">
                    <i class="fas fa-door-open text-info"></i>
                    Composition du bien
                </label>
                <p class="text-muted small mb-1 text-info">
                    D√©taillez les pi√®ces disponibles dans votre bien
                </p>
                <div class="row g-2" formGroupName="composition">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input id="lnombreChambres" type="number" min="0"
                                formControlName="nombreChambres" placeholder="" class="form-control"
                                [class.is-invalid]="isFieldInvalid('composition.nombreChambres')" />
                            <label for="lnombreChambres">Nombre de chambres </label>
                        </div>
                        @if (getFieldError('composition.nombreChambres', 'min')) {
                            <span class="error-message">La valeur saisie est incorrecte</span>
                        }
                        @else if (isFieldInvalid('composition.nombreChambres')) {
                            <span class="error-message">Veuillez saisir une valeur</span>
                        }
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input id="lnombreSalons" type="number" min="0"
                                formControlName="nombreSalons" placeholder="" class="form-control"
                                [class.is-invalid]="isFieldInvalid('composition.nombreSalons')" />
                            <label for="lnombreSalons">Nombre de salons </label>
                        </div>
                        @if (getFieldError('composition.nombreSalons', 'min')) {
                            <span class="error-message">La valeur saisie est incorrecte</span>
                        }
                        @else if (isFieldInvalid('composition.nombreSalons')) {
                            <span class="error-message">Veuillez saisir une valeur</span>
                        }
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input id="lnombreSallesBain" type="number" min="0"
                                formControlName="nombreSallesBain" placeholder="" class="form-control"
                                [class.is-invalid]="isFieldInvalid('composition.nombreSallesBain')" />
                            <label for="lnombreSallesBain">Nombre de douche </label>
                        </div>
                        @if (getFieldError('composition.nombreSallesBain', 'min')) {
                            <span class="error-message">La valeur saisie est incorrecte</span>
                        }
                        @else if (isFieldInvalid('composition.nombreSallesBain')) {
                            <span class="error-message">Veuillez saisir une valeur</span>
                        }
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input id="lnombreCuisine" type="number" min="0"
                                formControlName="nombreCuisine" placeholder="" class="form-control"
                                [class.is-invalid]="isFieldInvalid('composition.nombreCuisine')" />
                            <label for="lnombreCuisine">Nombre de cuisine </label>
                        </div>
                        @if (getFieldError('composition.nombreCuisine', 'min')) {
                            <span class="error-message">La valeur saisie est incorrecte</span>
                        }
                        @else if (isFieldInvalid('composition.nombreCuisine')) {
                            <span class="error-message">Veuillez saisir une valeur</span>
                        }
                    </div>

                    <div class="col-md-12">
                        <div class="form-floating">
                            <select id="toilettesVisiteurs" formControlName="toilettesVisiteurs" class="form-select" 
                                [class.is-invalid]="isFieldInvalid('composition.toilettesVisiteurs')">
                                <option value="">-- S√©lectionnez --</option>
                                <option [value]="false">Non</option>
                                <option [value]="true">Oui</option>
                            </select>
                            <label for="douche">Toilettes visiteurs disponibles <span class="text-danger"> *</span></label>
                        </div>
                        @if (isFieldInvalid('composition.toilettesVisiteurs')) {
                            <span class="error-message">Le bien poss√®de‚Äët‚Äëil des toilettes pour visiteurs ?</span>
                        }
                    </div>
                </div>
            </div>

            @if (bienForm.get('type')?.value === 'studio') {
                <div class="alert alert-info mt-2 mb-2">
                    <i class="fas fa-info-circle"></i>
                    Pour un <strong>studio</strong>, la composition est automatiquement d√©finie
                    (pi√®ce unique, sans chambre s√©par√©e).
                </div>

                

            }

            <!-- DESCRIPTION -->
            <div class="col-12">
                <div>
                    <app-rich-text-editor formControlName="description" [height]="200" 
                        [placeholder]="'Description d√©taill√©e ...'"
                        [toolbar]="'bold italic | underline  | blocks  | forecolor | backcolor | alignleft | alignright | numlist | bullist'"
                        [plugins]="['lists']"
                    ></app-rich-text-editor>
                </div>
                @if (isFieldInvalid('description')) {
                    <span class="error-message"> Une description compl√®te aide √† vendre ou louer plus vite</span>
                }
            </div>

            <!-- TRANSACTION GROUP -->
            <div class="col-md-12">
                <label class="mt-1 mb-1">
                    <i class="fas fa-handshake text-info"></i>
                    Transaction
                </label>
                <p class="text-muted small mb-1">
                    Souhaitez-vous vendre ou mettre en location ce bien ?
                </p>
                <div class="row g-2" formGroupName="transaction">
                    <div [class]="getTransactionType() === 'vente' ? 'col-md-6' : 'col-md-12'">
                        <div class="form-floating">
                            <select id="transactionType" formControlName="transactionType" class="form-select"
                                [class.is-invalid]="isFieldInvalid('transaction.transactionType')">
                                <option value="">-- S√©lectionnez --</option>
                                <option value="vente">üí∞ Vendre ce bien</option>
                                <option value="location">üîë Mettre en location</option>
                            </select>
                            <label for="transactionType">
                                Type de transaction <span class="text-danger">*</span>
                            </label>
                        </div>
                        @if (isFieldInvalid('transaction.transactionType')) {
                            <span class="error-message">Choisissez entre vente ou location</span>
                        }
                    </div>

                    <!-- PRIX DE VENTE (Affich√© uniquement pour VENTE) -->
                    @if (getTransactionType() === 'vente') {
                        <div class="col-md-6">
                            <app-currency-input id="prixVente" label="Montant de vente"
                                formControlName="prix" 
                                placeholder="Ex: 25 000 000"
                                [showNumericValue]="true"
                                [inputNgClass]="{'is-invalid': isFieldInvalid('transaction.prix')}"
                            ></app-currency-input>
                            @if (isFieldInvalid('transaction.prix')) {
                                <span class="error-message">Indiquez le prix de vente</span>
                            }
                        </div>
                    }

                    <!-- LOYER + P√âRIODE (Affich√© uniquement pour LOCATION) -->
                    @if (getTransactionType() === 'location') {
                        <!-- Montant du loyer -->
                        <div class="col-md-6">
                            <app-currency-input id="loyer" label="Loyer"
                                formControlName="prix" 
                                placeholder="Ex: 150 000"
                                [showNumericValue]="true"
                                [inputNgClass]="{'is-invalid': isFieldInvalid('transaction.prix')}"
                            ></app-currency-input>
                            @if (isFieldInvalid('transaction.prix')) {
                                <span class="error-message">Indiquez le montant du loyer</span>
                            }
                        </div>
                        
                        <!-- P√©riodicit√© du loyer -->
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select id="periodeLoyer" class="form-select"
                                    formControlName="periodeLoyer"
                                    [class.is-invalid]="isFieldInvalid('transaction.periodeLoyer')">
                                    <option value="">-- S√©lectionnez --</option>
                                    <option value="mois">/ Mois</option>
                                    <option value="annee">/ Ann√©e</option>
                                </select>
                                <label for="periodeLoyer">P√©riodicit√© du loyer <span class="text-danger"> *</span></label>
                            </div>
                            @if (isFieldInvalid('transaction.periodeLoyer')) {
                                <span class="error-message">Indiquez la p√©riodicit√© du loyer</span>
                            }
                        </div>

                        <!-- OPTIONS SUPPL√âMENTAIRES LOCATION -->
                        <div class="col-12">
                            <div class="location-extras">
                                <div class="row g-3">
                                    <!-- Caution -->
                                    <div class="col-6">
                                        <div class="form-floating">
                                            <select id="caution" class="form-select"
                                                formControlName="caution"
                                                [class.is-invalid]="isFieldInvalid('transaction.caution')">
                                                <option value="">-- S√©lectionnez --</option>
                                                <option [value]="0">Aucune caution</option>
                                                <option [value]="1">1 mois de caution</option>
                                                <option [value]="2">2 mois de caution</option>
                                                <option [value]="3">3 mois de caution</option>
                                                <option [value]="4">4 mois de caution</option>
                                                <option [value]="5">5 mois de caution</option>
                                                <option [value]="6">6 mois de caution</option>
                                            </select>
                                            <label for="caution">
                                                <i class="fas fa-shield-alt me-1"></i>
                                                Caution demand√©e <span class="text-danger"> *</span>
                                            </label>
                                        </div>
                                        @if (isFieldInvalid('transaction.prix')) {
                                            <span class="error-message">Indiquez la caution</span>
                                        }
                                    </div>

                                    <!-- AVANCE -->
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select id="avance" class="form-select" formControlName="avance"
                                                [class.is-invalid]="isFieldInvalid('transaction.avance')">
                                                <option value="">-- S√©lectionnez --</option>
                                                <option [value]="0">Aucune avance</option>
                                                <option [value]="1">1 mois d'avance</option>
                                                <option [value]="2">2 mois d'avance</option>
                                                <option [value]="3">3 mois d'avance</option>
                                                <option [value]="4">4 mois d'avance</option>
                                                <option [value]="5">5 mois d'avance</option>
                                                <option [value]="6">6 mois d'avance</option>
                                            </select>
                                            <label for="avance">
                                                <i class="fas fa-hand-holding-usd me-1"></i>
                                                Avance demand√©e <span class="text-danger"> *</span>
                                            </label>
                                        </div>
                                        @if (isFieldInvalid('transaction.avance')) {
                                            <span class="error-message">Indiquez une avance</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- LOCALISATION GROUP -->
            <div class="col-12">
                <label class="mt-1 mb-1">
                    <i class="fas fa-map-marker-alt text-info"></i>
                    Localisation du bien
                </label>
                <p class="text-muted small mb-1">
                    O√π se trouve votre bien ? Une localisation pr√©cise attire plus de visiteurs
                </p>
                <div class="row g-2" formGroupName="localisation">
                    <div class="col-md-6">
                        <app-search-select
                            [class.is-invalid]="isFieldInvalid('localisation.ville')"
                            id="ville" label="Ville" formControlName="ville"
                            [options]="liste_villes" [required]="true"
                        />
                        @if (isFieldInvalid('localisation.ville')) {
                            <span class="error-message">Veuillez s√©lectionner la ville</span>
                        }
                    </div>

                    <div class="col-md-6">
                        <app-search-select
                            [class.is-invalid]="isFieldInvalid('localisation.commune')"
                            id="commune" label="Commune / Quartier" formControlName="commune"
                            [options]="actual_communes()" [required]="true" [disabled]="actual_communes().length === 0"
                            [placeholder]="actual_communes().length === 0 ? '-- Aucune commune disponible --' : '-- S√©lectionnez --'"
                        />
                        @if (isFieldInvalid('localisation.commune')) {
                            <span class="error-message">Veuillez s√©lectionner la commune/Quartier</span>
                        }
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input id="llongitude" type="number" formControlName="longitude" 
                                placeholder="longitude" class="form-control" step="0.000001"
                                [class.is-invalid]="isFieldInvalid('localisation.longitude')" />
                            <label for="llongitude">Longitude (optionnel)</label>
                        </div>
                        @if (isFieldInvalid('localisation.longitude')) {
                            <span class="error-message">Veuillez saisir la longitude</span>
                        }
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input id="llatitude" type="number" formControlName="latitude" 
                                placeholder="latitude" class="form-control" step="0.000001"
                                [class.is-invalid]="isFieldInvalid('localisation.latitude')" />
                            <label for="llatitude">Latitude (optionnel)</label>
                        </div>
                        @if (isFieldInvalid('localisation.latitude')) {
                            <span class="error-message">Veuillez saisir la latitude</span>
                        }
                    </div>
                </div>
            </div>

            <!-- √âQUIPEMENTS -->
            <div class="col-12">
                <!-- <label class="mt-1 mb-1">
                    <i class="fas fa-list-check text-info"></i>
                    √âquipements disponibles
                </label> -->
                <p class="text-muted small mb-1 text-info">
                    S√©lectionnez les √©quipements inclus pour valoriser votre bien
                </p>
                <div class="row g-2">
                    <!-- √âquipements int√©rieurs -->
                    <div class="col-md-6">
                        <app-multi-select
                            id="equipinterior"
                            formControlName="equipementsInterieurs"
                            label="√âquipements int√©rieurs (optionnel)"
                            placeholder="Climatisation, Wi-Fi, Meubl√©..."
                            [options]="interiorOptions"
                            [removeItemButton]="true"
                            [searchable]="true"
                            [isInvalid]="isFieldInvalid('equipementsInterieurs')">
                        </app-multi-select>
                    </div>

                    <!-- √âquipements ext√©rieurs -->
                    <div class="col-md-6">
                        <app-multi-select
                            id="equipexterior"
                            formControlName="equipementsExterieurs"
                            label="√âquipements ext√©rieurs (optionnel)"
                            placeholder="Parking, Jardin, Piscine..."
                            [options]="exteriorOptions"
                            [removeItemButton]="true"
                            [searchable]="true"
                            [isInvalid]="isFieldInvalid('equipementsExterieurs')">
                        </app-multi-select>
                    </div>
                </div>
            </div>

            <!-- CONTACT GROUP -->
            <div class="col-12">
                <label class="mt-1 mb-2">
                    <i class="fas fa-user-circle text-info"></i>
                    Contact (Vos coordonn√©es)
                </label>
                <p class="text-muted small mb-1">
                    Ces informations permettront aux int√©ress√©s de vous contacter
                </p>
                <div class="row g-2" formGroupName="contact">
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input id="contactNom" type="text" 
                                formControlName="nom" placeholder="Nom" class="form-control"
                                [class.is-invalid]="isFieldInvalid('contact.nom')" />
                            <label for="contactNom">Nom du contact *</label>
                        </div>
                        @if (isFieldInvalid('contact.nom')) {
                            <span class="error-message">Veuillez saisir votre nom</span>
                        }
                    </div>

                    <div class="col-md-4">
                        <div class="form-floating">
                            <input id="contactTelephone" type="tel" 
                                formControlName="telephone" placeholder="+225 XX XX XX XX" class="form-control"
                                [class.is-invalid]="isFieldInvalid('contact.telephone')" />
                            <label for="contactTelephone">T√©l√©phone *</label>
                        </div>
                        @if (isFieldInvalid('contact.telephone')) {
                            <span class="error-message">Veuillez saisir le T√©l√©phone</span>
                        }
                    </div>

                    <div class="col-md-4">
                        <div class="form-floating">
                            <input id="contactEmail" type="email" 
                                formControlName="email" placeholder="email@exemple.com" class="form-control"
                                [class.is-invalid]="isFieldInvalid('contact.email')" />
                            <label for="contactEmail">Email (optionnel)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IMAGES ASSOCIEES -->
            <div class="col-12">
                <app-file-upload
                    label="Importer les images ou les vid√©os"
                    helperText="Format: PNG, JPG, MP4 (max 10MB)"
                    acceptedTypes="image/*,video/*"
                    [maxSize]="10485760"
                    [maxFiles]="7"
                    (filesSelected)="onFilesSelected($event)"
                    (fileRemoved)="onFileRemoved($event)"
                    (uploadComplete)="onUploadComplete($event)">
                </app-file-upload>
            </div>

            @if (errorMessage()) {
                <div class="alert alert-danger border-start border-danger border-4 mb-2 py-2" role="alert">
                    <i class="fas fa-times-circle me-1"></i> {{ errorMessage() }}
                </div>
            }
















            <div class="col-12 gy-6">
                <div class="row g-3 justify-content-end">
                    <!-- <div class="col-auto">
                        <button class="btn btn-phoenix-primary px-5">Annuler</button>
                    </div> -->
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary px-5 px-sm-15">Enregistrer</button>
                    </div>

                    <div class="col-auto">
                        <button type="submit" 
                            class="btn btn-primary px-5 px-sm-15 position-relative overflow-hidden" disabled>
                                <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-wave bg-white" style="height: 100%; width: 40%;"></div>
                                </div>
                                
                                <span class="d-flex align-items-center position-relative">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Envoi en cours ...</span>
                                </span>
                        </button>
                    </div>


                </div>
            </div>
        </form>
    </div>
</div>