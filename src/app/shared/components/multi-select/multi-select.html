<!-- multi-select.component.html - Version avec classes améliorées -->

<div 
  class="multi-select-wrapper"
  [class.is-disabled]="disabled"
>
  <!-- Label -->
  @if (label) {
    <label [for]="id" class="ms-label">
      {{ label }}
    </label>
  }

  <!-- Trigger -->
  <div
    class="multi-select-trigger"
    [class.is-open]="isOpen()"
    [class.is-invalid]="isInvalid"
    [class.is-valid]="isValid"
    [class.disabled]="disabled"
    (click)="toggleDropdown($event)"
    (keydown)="onKeyDown($event)"
    [attr.tabindex]="disabled ? -1 : 0"
    role="combobox"
    [attr.aria-expanded]="isOpen()"
  >
    <!-- Tags sélectionnés -->
    @if (selectedOptions().length > 0) {
      @for (option of selectedOptions(); track option.value) {
        <span class="ms-tag tag-{{ getBadgeColor(option) }}">
          @if (option.icon) {
            <i [class]="option.icon" class="ms-tag-icon"></i>
          }
          <span class="ms-tag-label">{{ option.label }}</span>
          @if (removeItemButton && !disabled) {
            <button
              type="button"
              class="ms-tag-remove"
              (click)="removeOption(option, $event)"
              [attr.aria-label]="'Supprimer ' + option.label"
            >
              <i class="fas fa-times"></i>
            </button>
          }
        </span>
      }
    } @else {
      <span class="ms-placeholder">{{ placeholder }}</span>
    }

    <span class="flex-grow-1"></span>

    <!-- Clear All -->
    @if (selectedOptions().length > 1 && !disabled) {
      <button
        type="button"
        class="ms-clear-btn"
        (click)="clearAll($event)"
        title="Tout effacer"
      >
        <i class="fas fa-times-circle"></i>
      </button>
    }

    <!-- Flèche -->
    <span class="dropdown-arrow" [class.rotate-180]="isOpen()">
      <i class="fas fa-chevron-down"></i>
    </span>
  </div>

  <!-- Dropdown -->
  @if (isOpen()) {
    <div class="multi-select-dropdown">
      <!-- Recherche -->
      @if (searchable) {
        <div class="ms-search-wrapper position-relative">
          <i class="fas fa-search ms-search-icon"></i>
          <input
            type="text"
            class="ms-search-input"
            [placeholder]="searchPlaceholder"
            [value]="searchQuery()"
            (input)="onSearchInput($event)"
            (keydown)="onKeyDown($event)"
            autocomplete="off"
          />
          @if (searchQuery()) {
            <button
              type="button"
              class="ms-search-clear"
              (click)="searchQuery.set('')"
            >
              <i class="fas fa-times"></i>
            </button>
          }
        </div>
      }

      <!-- Compteur -->
      @if (maxSelection > 0) {
        <div class="ms-selection-counter">
          <i class="fas fa-layer-group"></i>
          {{ selectionCountText() }}
        </div>
      }

      <!-- Options -->
      <div class="ms-options-list">
        @if (availableOptions().length > 0) {
          @for (option of availableOptions(); track option.value; let i = $index) {
            <div
              class="ms-option"
              [class.highlighted]="highlightedIndex() === i"
              [class.disabled]="option.disabled || isMaxReached()"
              (click)="selectOption(option, $event)"
              (mouseenter)="highlightedIndex.set(i)"
            >
              <div class="ms-option-content">
                @if (option.icon) {
                  <i [class]="option.icon" class="ms-option-icon"></i>
                }
                <span>{{ option.label }}</span>
              </div>
              
              @if (!option.disabled && !isMaxReached()) {
                <span class="ms-option-action">
                  <i class="fas fa-plus"></i>
                </span>
              }
            </div>
          }
        } @else {
          <div class="ms-no-results">
            <i class="fas fa-search"></i>
            {{ noResultsText }}
          </div>
        }
      </div>

      <!-- Sélectionnés -->
      @if (selectedOptions().length > 0) {
        <div class="ms-selected-section">
          <div class="ms-selected-header">
            <i class="fas fa-check-double me-1"></i>
            Sélectionnés ({{ selectedOptions().length }})
          </div>
          @for (option of selectedOptions(); track option.value) {
            <div class="ms-selected-option">
              <span>
                @if (option.icon) {
                  <i [class]="option.icon + ' me-2'"></i>
                }
                {{ option.label }}
              </span>
              @if (removeItemButton && !disabled) {
                <button
                  type="button"
                  class="ms-selected-remove"
                  (click)="removeOption(option, $event)"
                >
                  <i class="fas fa-trash-alt me-1"></i>
                  Retirer
                </button>
              }
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Message d'erreur -->
  @if (isInvalid) {
    <div class="ms-error-message">
      <i class="fas fa-exclamation-circle"></i>
      <ng-content select="[error-message]"></ng-content>
    </div>
  }
</div>
